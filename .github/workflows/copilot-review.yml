name: Copilot Review

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - main
      - develop

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  copilot-review:
    name: AI Code Review
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v41
        with:
          separator: ","

      - name: Auto-label by component
        uses: actions/github-script@v7
        with:
          script: |
            const changedFiles = '${{ steps.changed-files.outputs.all_changed_files }}'.split(',');
            const labels = new Set();

            // Component detection
            changedFiles.forEach(file => {
              if (file.includes('src/handlers/search')) labels.add('component: search');
              if (file.includes('src/providers/gemini') || file.includes('scan-bookshelf')) labels.add('component: ai');
              if (file.includes('cache') || file.includes('KV')) labels.add('component: cache');
              if (file.includes('websocket') || file.includes('durable-objects')) labels.add('component: websocket');
              if (file.includes('enrichment')) labels.add('component: enrichment');
              if (file.includes('validation')) labels.add('component: validation');
              if (file.includes('providers/')) labels.add('component: providers');
              if (file.includes('src/index.js') || file.includes('routes')) labels.add('component: routing');
              if (file.includes('wrangler.toml')) labels.add('component: workers');

              // Type detection
              if (file.includes('test/') || file.includes('.test.js')) labels.add('type: testing');
              if (file.includes('docs/')) labels.add('type: documentation');
              if (file.includes('.github/workflows/')) labels.add('type: ci-cd');
              if (file.includes('package.json') || file.includes('package-lock.json')) labels.add('type: dependencies');
            });

            // Add AI collaboration label
            labels.add('ai: copilot');

            if (labels.size > 0) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                labels: Array.from(labels)
              });
            }

      - name: Estimate effort
        uses: actions/github-script@v7
        with:
          script: |
            const changedFiles = '${{ steps.changed-files.outputs.all_changed_files }}'.split(',');
            const additions = ${{ steps.changed-files.outputs.added_files_count }} || 0;
            const modifications = ${{ steps.changed-files.outputs.modified_files_count }} || 0;
            const deletions = ${{ steps.changed-files.outputs.deleted_files_count }} || 0;
            const totalChanges = additions + modifications + deletions;

            let effortLabel = '';

            if (totalChanges <= 2) {
              effortLabel = 'effort: XS (<2h)';
            } else if (totalChanges <= 5) {
              effortLabel = 'effort: S (2-4h)';
            } else if (totalChanges <= 10) {
              effortLabel = 'effort: M (4-8h)';
            } else if (totalChanges <= 20) {
              effortLabel = 'effort: L (1-3d)';
            } else {
              effortLabel = 'effort: XL (3-5d)';
            }

            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              labels: [effortLabel]
            });

      - name: Security scan for hardcoded secrets
        id: secret-scan
        run: |
          echo "Scanning for hardcoded secrets..."
          SECRETS_FOUND=false

          # Patterns to detect
          PATTERNS=(
            "AIza[A-Za-z0-9_-]{35}"  # Google API keys
            "sk-[A-Za-z0-9]{48}"     # OpenAI keys
            "ghp_[A-Za-z0-9]{36}"    # GitHub tokens
            "password.*['\"][^'\"]{8,}['\"]"
          )

          for pattern in "${PATTERNS[@]}"; do
            if git diff origin/main...HEAD | grep -iE "$pattern" > /dev/null; then
              echo "‚ö†Ô∏è  Warning: Potential secret detected: $pattern"
              SECRETS_FOUND=true
            fi
          done

          if [ "$SECRETS_FOUND" = true ]; then
            echo "secrets_found=true" >> $GITHUB_OUTPUT
          else
            echo "secrets_found=false" >> $GITHUB_OUTPUT
          fi

      - name: Comment on PR with security warning
        if: steps.secret-scan.outputs.secrets_found == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const body = `## ‚ö†Ô∏è Security Warning

            Potential hardcoded secrets detected in this PR!

            **Action Required:**
            - Review changes for API keys, passwords, or tokens
            - Use \`wrangler secret put\` for production secrets
            - Use \`.dev.vars\` for local development (gitignored)

            **Detected patterns:**
            - Google API keys (AIza...)
            - OpenAI keys (sk-...)
            - GitHub tokens (ghp_...)
            - Hardcoded passwords

            If this is a false positive, please document why in PR description.
            `;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: body
            });

      - name: Check for missing tests
        id: test-check
        run: |
          echo "Checking for test coverage..."
          MISSING_TESTS=false

          # Get new handler files
          NEW_HANDLERS=$(git diff --name-only --diff-filter=A origin/main...HEAD | grep "src/handlers/.*\.js$" || true)

          if [ -n "$NEW_HANDLERS" ]; then
            for handler in $NEW_HANDLERS; do
              test_file=$(echo "$handler" | sed 's|src/|test/|' | sed 's|\.js$|.test.js|')

              if [ ! -f "$test_file" ]; then
                echo "‚ö†Ô∏è  Missing test file: $test_file for $handler"
                MISSING_TESTS=true
              fi
            done
          fi

          if [ "$MISSING_TESTS" = true ]; then
            echo "missing_tests=true" >> $GITHUB_OUTPUT
          else
            echo "missing_tests=false" >> $GITHUB_OUTPUT
          fi

      - name: Comment about missing tests
        if: steps.test-check.outputs.missing_tests == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const body = `## üß™ Test Coverage Reminder

            New handlers detected without corresponding test files.

            **Best Practice:**
            - Every handler in \`src/handlers/\` should have tests in \`test/\`
            - Naming convention: \`src/handlers/search.js\` ‚Üí \`test/handlers/search.test.js\`

            **To add tests:**
            \`\`\`bash
            # Create test file
            touch test/handlers/your-handler.test.js

            # Run tests
            npm test
            \`\`\`

            See existing test files for examples!
            `;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: body
            });

      - name: Check markdown links
        uses: gaurav-nelson/github-action-markdown-link-check@v1
        with:
          use-quiet-mode: 'yes'
          use-verbose-mode: 'no'
          config-file: '.github/markdown-link-check-config.json'
        continue-on-error: true

      - name: Comment PR summary
        uses: actions/github-script@v7
        with:
          script: |
            const changedFiles = '${{ steps.changed-files.outputs.all_changed_files }}'.split(',').filter(f => f);
            const additions = ${{ steps.changed-files.outputs.added_files_count }} || 0;
            const modifications = ${{ steps.changed-files.outputs.modified_files_count }} || 0;
            const deletions = ${{ steps.changed-files.outputs.deleted_files_count }} || 0;

            const body = `## ü§ñ Copilot Review Summary

            **Files Changed:** ${changedFiles.length}
            - ‚ûï Added: ${additions}
            - üìù Modified: ${modifications}
            - ‚ùå Deleted: ${deletions}

            **Auto-labeling complete!** Check the labels for component, effort, and type detection.

            ---

            **Next Steps:**
            1. Request review from @jules for detailed code analysis
            2. Ensure all tests pass
            3. Update \`docs/API_README.md\` if endpoints changed
            4. Verify pre-commit hooks passed locally

            **Need help?**
            - Ask @jules: \`@jules review this PR for backend best practices\`
            - Security audit: Run Zen MCP \`/code-review review_type=security\`
            `;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: body
            });
