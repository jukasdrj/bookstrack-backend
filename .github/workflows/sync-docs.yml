name: üìö Sync API Docs to Other Repos

# This workflow syncs API documentation from backend to iOS/Flutter repos
# 
# Requirements:
# - GITHUB_TOKEN secret must be a Personal Access Token (PAT) with 'repo' scope
#   The default GITHUB_TOKEN doesn't have permission to push to other repositories
# - To create a PAT: Settings ‚Üí Developer settings ‚Üí Personal access tokens ‚Üí 
#   Generate new token (classic) ‚Üí Select 'repo' scope
# - Add as secret: Repository Settings ‚Üí Secrets ‚Üí Actions ‚Üí New repository secret
#   Name: GITHUB_TOKEN (overwrites the default)

on:
  push:
    branches: [main]
    paths:
      - 'docs/API_README.md'
      - 'docs/QUICK_START.md'
      - '.github/workflows/sync-docs.yml'

jobs:
  sync-to-ios:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Sync docs to iOS repo
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Configure git
          git config --global user.email "claude@anthropic.com"
          git config --global user.name "Claude Code"
          
          # Clone iOS repo (shallow) with authentication
          git clone --depth 1 https://x-access-token:${GITHUB_TOKEN}@github.com/jukasdrj/books-tracker-v1.git /tmp/ios-repo 2>&1 || {
            echo "‚ö†Ô∏è  Could not clone iOS repo (may not exist yet)"
            exit 0
          }
          
          # Create docs dir if needed
          mkdir -p /tmp/ios-repo/docs
          
          # Copy files
          cp docs/API_README.md /tmp/ios-repo/docs/
          cp docs/QUICK_START.md /tmp/ios-repo/docs/
          
          # Commit and push if changed
          cd /tmp/ios-repo
          if ! git diff --quiet docs/; then
            git add docs/API_README.md docs/QUICK_START.md
            git commit -m "docs: sync API documentation from backend" \
              -m "Synced from bookstrack-backend: ${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}" \
              -m "- API_README.md: Canonical contracts, endpoints, WebSocket protocol" \
              -m "- QUICK_START.md: Quick reference for common tasks" \
              -m "Keep in sync with: github.com/jukasdrj/bookstrack-backend/docs/"
            git push https://x-access-token:${GITHUB_TOKEN}@github.com/jukasdrj/books-tracker-v1.git main
            echo "‚úÖ iOS repo docs updated"
          else
            echo "‚ÑπÔ∏è  No changes to sync to iOS repo"
          fi

  sync-to-flutter:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    if: vars.FLUTTER_REPO_ENABLED == 'true'
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Sync docs to Flutter repo
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Configure git
          git config --global user.email "claude@anthropic.com"
          git config --global user.name "Claude Code"
          
          # Clone Flutter repo (shallow) with authentication
          git clone --depth 1 https://x-access-token:${GITHUB_TOKEN}@github.com/jukasdrj/bookstrack-flutter.git /tmp/flutter-repo 2>&1 || {
            echo "‚ö†Ô∏è  Could not clone Flutter repo (may not exist yet)"
            exit 0
          }
          
          # Create docs dir if needed
          mkdir -p /tmp/flutter-repo/docs
          
          # Copy files
          cp docs/API_README.md /tmp/flutter-repo/docs/
          cp docs/QUICK_START.md /tmp/flutter-repo/docs/
          
          # Commit and push if changed
          cd /tmp/flutter-repo
          if ! git diff --quiet docs/; then
            git add docs/API_README.md docs/QUICK_START.md
            git commit -m "docs: sync API documentation from backend" \
              -m "Synced from bookstrack-backend: ${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}" \
              -m "- API_README.md: Canonical contracts, endpoints, WebSocket protocol" \
              -m "- QUICK_START.md: Quick reference for common tasks" \
              -m "Keep in sync with: github.com/jukasdrj/bookstrack-backend/docs/"
            git push https://x-access-token:${GITHUB_TOKEN}@github.com/jukasdrj/bookstrack-flutter.git main
            echo "‚úÖ Flutter repo docs updated"
          else
            echo "‚ÑπÔ∏è  No changes to sync to Flutter repo"
          fi

  notify:
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Summary
        run: echo "üìö Documentation sync workflow complete"
